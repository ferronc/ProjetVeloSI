<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Générateur</title>
    </head>
 
    <body>
        <h1>Générateur d'événement !</h1>

		<h2>Batterie</h2>
        <p><input type="button" value="Charger la batterie" id="chargerBatterie" /></p>
		<p><input type="button" value="Décharger la batterie" id="dechargerBatterie" /></p>
		<p><input type="button" value="Etat batterie" id="etat" /></p>
		
		<h2>Parcours</h2>
		<p><input type="button" value="Débuter le parcours" id="debuterParcours" /></p>
		<p><input type="button" value="Stopper le parcours" id="stopperParcours" /></p>
		<p><input type="button" value="Reprendre le parcours" id="reprendreParcours" /></p>
		<p><input type="button" value="Distance parcourue" id="distanceParcourue" /></p>
		<p><input type="button" value="Distance restante" id="distanceRestante" /></p>
		<p><input type="button" value="Vitesse actuelle" id="vitesseActuelle" /></p>
		
		<h2>Interruption</h2>
		<p><input type="button" value="STOP" id="stop" /></p>
		
        <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script>
		
		var socket = io.connect('http://localhost:8080');
		
		/* *************************************************
				Gestion des événements batterie
		   ************************************************* */
		
		var chargeBatterie = 50; 	// Etat de charge de la batterie
		var cycleCharge = 1000;	 	// Temps du cycle pour chaque itération du chargement de la batterie (en milliseconde)
		var cycleDecharge = 2000; 	// Temps du cycle pour chaque itération du déchargement de la batterie (en milliseconde)
		
		// Timing events (to execute a function, over and over again, at specified time intervals)
		var intervalBatterieCharge; 
		var intervalBatterieDecharge = setInterval(function() {dechargerBatterie()}, cycleDecharge);
		
		/** Permet de charger la batterie */
		function chargerBatterie(){
			chargeBatterie++;
			if(chargeBatterie >= 100){
				chargeBatterie = 100;
				// Interruption du timing event
				window.clearInterval(intervalBatterieCharge); 
				// On émet un événement 'alarmeFinDeCharge' vers le serveur
				socket.emit('alarmeFinDeCharge', 'INFO : La charge de la batterie est terminée');
			}
			socket.emit('etatBatterie', chargeBatterie);
		}
		
		/** Permet de décharger la batterie */
		function dechargerBatterie(){
			chargeBatterie--;
			if(chargeBatterie <= 0){
				chargeBatterie = 0;
				window.clearInterval(intervalBatterieDecharge);
				socket.emit('message', "INFO : La batterie est complètement déchargée");
			}
			socket.emit('etatBatterie', chargeBatterie);
		}
		
		// Fonctions appelées aux actions réalisées sur les boutons identifiés par leurs identifiants
		$('#chargerBatterie').click(function () {
			// Interruption des timing events (pour éviter des précédentes exécution toujours en cours)
			window.clearInterval(intervalBatterieDecharge);
			window.clearInterval(intervalBatterieCharge);
			// On émets les événements associés puis on relance le timing event
			socket.emit('message', 'INFO : La batterie se charge');
			socket.emit('etatBatterie', chargeBatterie);
			intervalBatterieCharge = setInterval(function() {chargerBatterie()}, cycleCharge);
		})
		$('#dechargerBatterie').click(function () {
			window.clearInterval(intervalBatterieCharge);
			window.clearInterval(intervalBatterieDecharge);
			socket.emit('message', 'INFO : La batterie se décharge');
			socket.emit('etatBatterie', chargeBatterie);
			intervalBatterieDecharge = setInterval(function() {dechargerBatterie()}, cycleDecharge);
		})
		$('#etat').click(function () {
			socket.emit('etatBatterie', chargeBatterie);
		})
		
		/* ***********************************************
				Gestion des événements parcours
		 ************************************************* */
		
		var vitesse = 0; // Vitesse courante du vélo
		var intervalVitesse; // Timing event
		var cycleVitesse = 1000; // Temps du cycle pour chaque itération de la vitesse (en milliseconde) 
		var distanceAParcourir = 200; // En mètre
		var distanceParcourue = 0; // En mètre
		var aleatoire = 0; // Valeur aléatoire
		
		// Variable pour records
		var vitesseMax = 0;
		var distanceTotal = 0;
		var distanceMaxEntreDeuxCharges = 0;
		
		/** Permet de générer la vitesse */
		function genererVitesse(){
			// Return a random number between 1 and 7 meter/sec
			aleatoire = Math.floor((Math.random() * 7) + 1); //generation of the speed
			
			// On simule des pentes montantes ou descendantes -> variation de la vitesse
			if(vitesse > aleatoire){
				vitesse--;
			}
			if(vitesse < aleatoire){
				vitesse++;
			}
			
			if(vitesse > vitesseMax){
				vitesseMax = vitesse;
				socket.emit('recordVitesseMax', vitesseMax);
			}
			
			// Gestion de la batterie pour vérifier qu'on peut terminer le parcours
			var tmp = (vitesse*0.1);
			if(tmp > chargeBatterie){
				vitesse = 0;
				tmp = 0;
				socket.emit('message', 'INFO : Un problème est survenu, plus de batterie pour terminer le parcours');
				window.clearInterval(intervalVitesse);
			}
			
			chargeBatterie -= tmp;
			socket.emit('etatBatterie', chargeBatterie.toFixed(2));
			
			calculParcours();
		}
		
		/** Permet de calculer la distance parcourue et restante */
		function calculParcours(){
			distanceParcourue += vitesse;
			distanceAParcourir -= vitesse;
			distanceTotale += vitesse;
			socket.emit('distanceParcourue', distanceParcourue);
			socket.emit('recordDistanceTotale', distanceTotale);
			if(distanceAParcourir <= 0){
				window.clearInterval(intervalVitesse);
				socket.emit('message', 'INFO : Le parcours est terminé, félicitation !');
			}
		}
		
		// Fonctions appelées aux actions réalisées sur les boutons identifiés par leurs identifiants
		$('#debuterParcours').click(function () {
			window.clearInterval(intervalVitesse);
			socket.emit('message', 'INFO : Le parcours commence, distance à parcourir : '+distanceAParcourir);
			intervalVitesse = setInterval(function() {genererVitesse()}, cycleVitesse);
		})
		
		$('#stopperParcours').click(function () {
			window.clearInterval(intervalVitesse);
			socket.emit('message', 'INFO : Vous prenez une pause dans votre parcours');
		})
		
		$('#reprendreParcours').click(function () {
			window.clearInterval(intervalVitesse);
			socket.emit('message', 'INFO : Vous reprenez votre parcours');
			intervalVitesse = setInterval(function() {genererVitesse()}, cycleVitesse);
		})	
		
		$('#distanceParcourue').click(function () {
			socket.emit('message', 'Distance parcourue : '+distanceParcourue);
		})
		$('#vitesseActuelle').click(function () {
			socket.emit('message', 'Vitesse actuelle : '+vitesse);
		})
		$('#distanceRestante').click(function () {
			socket.emit('message', 'Distance restante : '+distanceAParcourir);
		})
		
		// Interruption
		
		$('#stop').click(function () {
			window.clearInterval(intervalBatterieCharge);
			window.clearInterval(intervalBatterieDecharge);
			window.clearInterval(intervalVitesse);
		})
		
        </script>
    </body>
</html>